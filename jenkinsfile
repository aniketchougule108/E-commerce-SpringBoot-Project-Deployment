pipeline {
    agent any

    environment {
        GITHUB_REPO_URL = "https://github.com/aniketchougule108/E-commerce-SpringBoot-Project-Deployment.git"
        GIT_BRANCH      = "main"
        SSH_CRED_ID     = "jarvis-key"
        EC2_IP          = "52.66.92.181"
        REMOTE_USER     = "ubuntu"
        APP_PATH        = "/opt/ecom-app"
        PROJECT_DIR     = "JtProject"
        JAR_NAME        = "app.jar"
        SERVICE_NAME    = "ecom.service"
    }

    stages {

        stage('Checkout Code') {
            steps {
                echo "Cloning ${env.GITHUB_REPO_URL} (branch: ${env.GIT_BRANCH})"
                git branch: env.GIT_BRANCH, url: env.GITHUB_REPO_URL
            }
        }

        stage('Build with Maven') {
            steps {
                echo "Building Maven project in ${env.PROJECT_DIR}..."
                dir("${env.PROJECT_DIR}") {
                    timeout(time: 7, unit: 'MINUTES') {
                        sh 'mvn -B clean package -DskipTests'
                    }
                }
            }
        }

        stage('Deploy to EC2') {
            steps {
                echo "Deploying JAR to EC2 ${env.EC2_IP}"
                sshagent(credentials: [env.SSH_CRED_ID]) {
                    script {
                        def localJar = sh(script: "ls ${env.PROJECT_DIR}/target/*.jar | head -n 1", returnStdout: true).trim()
                        if (!localJar) {
                            error "No JAR found in target directory."
                        }
                        echo "Deploying ${localJar}"

                        sh """
                            ssh -o StrictHostKeyChecking=no ${env.REMOTE_USER}@${env.EC2_IP} '
                                sudo mkdir -p ${env.APP_PATH} &&
                                sudo chown ${env.REMOTE_USER}:${env.REMOTE_USER} ${env.APP_PATH}
                            '
                            scp -o StrictHostKeyChecking=no ${localJar} ${env.REMOTE_USER}@${env.EC2_IP}:${env.APP_PATH}/${env.JAR_NAME}
                            ssh -o StrictHostKeyChecking=no ${env.REMOTE_USER}@${env.EC2_IP} '
                                sudo systemctl daemon-reload &&
                                sudo systemctl restart ${env.SERVICE_NAME} &&
                                sudo systemctl status ${env.SERVICE_NAME} --no-pager
                            '
                        """
                    }
                }
            }
        }

        stage('Smoke Check') {
            steps {
                script {
                    def url = "http://${env.EC2_IP}:8080"
                    echo "Checking application availability at ${url}"
                    sh returnStatus: true, script: "curl -sSf --max-time 5 ${url} || echo 'Smoke check failed'"
                }
            }
        }
    }

    post {
        success { echo "üéâ Pipeline SUCCESS ‚Äî Deployed to EC2 ${env.EC2_IP}" }
        failure { echo "‚ùå Pipeline FAILED ‚Äî Check console" }
        always { deleteDir() }
    }
}
